# h3 No Strings Attached

Kotitehtävä h3 No Strings Attached Tero Karvisen & Lari Iso-Anttilan Verkkoon tunkeutuminen ja tiedustelu - 2025 syksy kurssille. [Linkki kurssisivulle](https://terokarvinen.com/application-hacking/)
Jokaisessa kohdassa on alla olevalla "quote" tyylillä kerrottu tehtävänanto.
>Liirum laarum laa...




## a)
> Strings. Download ezbin-challenges.zip. Run 'passtr'. Find the correct password using 'strings'. Also find the flag. (Preferably without looking at the source, if you can.)

Latasin Teron ezbin-challenges.zip tiedoston jonka jälkeen siirsin sen omaan kansioon `h3`. Sen jälkeen unzippasin sen ja katsoin mitä kaikkea unzipatusta kansiosta löytyi. 

![alt text](image.png)

Tämän jälkeen menin vielä `passtr` kansioon josta löytyi seuraavat tiedostot. Samalla luin readme.md tiedoston 

    cat README.md

![alt text](image-1.png)

Suoritin kyseiset komennot jonka jälkeen käynnistin binäärin. 

![alt text](image-2.png)

Katsoin miten binääri toimii testaamalla muutamaa inputtia.

![alt text](image-3.png)

Lähdin katsomaan binääriä strings:n avulla 

    strings ./passtr | less

Alla koko strings antama output

![alt text](image-4.png)

![alt text](image-5.png)

![alt text](image-6.png)

Kuten ensimmäisestä kuvasta näkyy salasana on `sala-hakkeri-321` ja flag `FLAG{Tero-d75ee66af0a68663f15539ec0f46e3b1}`. Testasin tämän jälkeen vielä salasanaa itse binääriin ja se antoi saman flagin mitä näkyi strings:n avulla.

![alt text](image-7.png)


## b
> Make a new version of the passtr.c program where the password doesn't appear directly as-is in the binary. Demonstrate with a test that the password doesn't appear. (Obfuscation is sufficient.)

Aluksi tein kopion alkuperäisestä lähdekoodista jonka jälkeen avasin sen microlla

    cp passtr.c kopioc
    micro kopio.c

Lähdekoodina oli noin 10 rivin koodipätkä, joka näytti näin ei C-koodaajalle yllättävän simppelille. 

Lähdin etsimään tietoa googlesta hakulauseella `string obfuscation in c` ja valitsin hakutuloksista tällaisen artikkelin

![alt text](image-8.png)

Alla artikkelista otettu kuvankaappaus, jossa tarvittava koodinpätkä ([Yuri Slobodyanyuk Binary obfuscation - String obfuscating in C](https://yurisk.info/2017/06/25/binary-obfuscation-string-obfuscating-in-C/))

![alt text](image-9.png)

Lähdinkin testaamaan tätä koodiin ja sain tämänlaisen koodinpätkän.

![alt text](image-10.png)

Seuraavaksi testasin compilata tätä koodia gcc komennon avulla `gcc -o testi kopio.c`
- -o output filen nimi eli testi
- kopio.c lähdekoodi mistä compilataan

Ja sain muutaman error messagen.

![alt text](image-11.png)

Ennen kuin lähdin sen enempää korjaamaan koodia, päätin katsoa toimiiko kyseinen tapa ollenkaan ns omana koodina.

Kopion Yurin koodin omaan tiedostoon binary.c jonka jälkeen compilasin sen

![alt text](image-12.png)

`gcc -o binary  binary.c
`

Koodi toimii oletetusti, kun suoritan binäärin se antaa stringin "here goes the secret we hide".

    └─$ ./binary 
    Here goes the secret we hide: secret password                                                 
Mutta kun koodia katsoo strings avulla `strings ./binary | less
` ei salaista stringia näy, vaan sen sijaan näkyy vain `Here goes the secret we hide: %s
;*3$"
`

![alt text](image-13.png)

![alt text](image-14.png)

Koodi siis toimii halutulla tavalla, mutta nyt se pitäisi vain saada yhdistettyä alkuperäiseen lähdekoodiin.

Riviltä 22 minulta puuttui ; joten laitoin rivin päätteeksi sen.

![alt text](image-15.png)

Tämä vähensi errorien määrää, mutta silti koodissa oli vielä muutama errori

![alt text](image-16.png)

Kysyin tekoälyltä (Gemini 3 Pro-mode) mikä koodissa on ongelmana. Koodissa oli se ongemla, että funktio `UNHIDE_STRING` oli if loopin sisällä aiheuttaen errorin. 

Nyt korjasin sen, eli muutin 

``f (0 == strcmp(password, UNHIDE_STRING(str1)))``

`UNHIDE_STRING(str1);
if (0 == strcmp(password, str1))`

Alla vielä kuva koko lähdekoodista.

![alt text](image-17.png)

Seuraavaksi testasin compilata koodin ja se onnistui ilman erroreita,

![alt text](image-18.png)

Testasin, että koodi toimii kuten pitäisi

![alt text](image-19.png)

Ei toiminut ja kuten voisi olettaa, oli virheenä typo koodissa

![alt text](image-20.png)

Tällä hetkellä salasana on `sala-hhakkeri123` eikä `sala-hakkeri-321`

Muutin tämän oikeaan muotoon, vaikka tehtävää olisikin voinut jatkaa vain kirjoittamalla salasanaan "väärän" salasanan.

![alt text](image-21.png)

Compilasin koodin uudestaan ja nyt ohjelma toimii kuten pitäisikin.

![alt text](image-22.png)

Lähdin katsomaan näkyykö salasana enää yhtä selkeästi strings avulla `strings ./testi |less`

![alt text](image-23.png)

Salasana ei näkynyt selkeästi eli nyt koodi on korjattu. Koodista vielä ehkä kannattaisi tehdä sama Flagille, mutta se ei kuulunut tämän tehtävän scopeen.

## c
> Packd. Run 'packd' from the package ezbin-challenges.zip. What is the password? What is the flag? (This task is slightly more challenging. Write down the approaches you tried and hypotheses you came up with. Hopefully you'll reach the goal yourself, but if not, the walkthrough will be revealed in class...)

Menin ``/challenges/packd`` kansioon ja suoritin packd binäärin.

![alt text](image-24.png)

Ainaskin näin funktionaalisesti tämä näyttää samalta kuin b osan haaste. 

Katsoin binääriä strings avulla `strings ./packd |less
`

Alla koko strings output

![alt text](image-25.png)

![alt text](image-26.png)

![alt text](image-27.png)

Ensimmäisestä kuvasta löytyvä teksti`$Info: This file is packed with the UPX executable packer http://upx.sf.net $
$Id: UPX 4.21 Copyright (C) 1996-2023 the UPX Team. All Rights Reserved. $
_RPWQM)
` herätti heti huomion, sitä tätä ei ollut aikaisemmassa tehtävässä. UPX on jonkin sortin paketointityökalu ``"UPX is a free, secure, portable, extendable, high-performance
executable packer for several executable formats"``(UPX dokumentaatio). Googlettelin asiaa hetken ja vastaan tuli Youtube video, John Hammond, [Unpacking UPX Binaries](https://www.youtube.com/watch?v=0jVikfySiII). Videossa hän käytti Ghidraa joten päätin asentaa sen. 

### Ghidran asentaminen

Lähdin asentamaan Ghidra työkalua (https://github.com/NationalSecurityAgency/ghidra).

    sudo apt-get install openjdk-21-jdk

Ghidrasta uusin versio oli 12.0.2 joka oltiin julkaistu noin muutama päivä ennen kuin aloin tekemään tätä tehtävää. Tästä syystä latasin 12.0.1 version joka on julkaistu noin kaksi viikkoa sitten. 

    wget https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_12.0.1_build/ghidra_12.0.1_PUBLIC_20260114.zip


    unzip ghidra_12.0.1_PUBLIC_20260114.zip 

    cd ghidra_12.0.1_PUBLIC

    ./ghidraRun

![alt text](image-28.png)

Seuraavaksi tein uuden projektin `File --> New project --> Non-Shared project -->`

Sitten klikkasin "Open new CodeBrowser" jonka jälkeen importasin siihen kyseisen packd ohjelman. 

![alt text](image-29.png)

![alt text](image-30.png)

Painoin Yes

![alt text](image-31.png)

Tästä en muuttanut mitään, --> Analyze

![alt text](image-32.png)

Antoi tällaisen, joka ei juuri auttanut hriveästi.

Isompaan ikkunaan minulla avautui tämä codebrowser, joka näytti tältä.

![alt text](image-33.png)

Suurensin oikeaa puolta, missä näkyi koodi C kielessä eikä assemblyssa.

![alt text](image-34.png)

Katsoin eteenpäin John Hammondin videota ja hän meni vasemmalta "functions" kohtaan. 

![alt text](image-35.png)

Näistä suurin osa oli tämän näköisiä

![alt text](image-36.png)

Ensimmäinen joka iski silmään oli `FUN_001054d0` joka näytti tältä. 

![alt text](image-37.png)

Se miksi tämä pisti silmään oli tämä funktio jossa selkeästi tehdään joku paikallinen variable ja verrataan sitä. Tämä funktio muistuttaa edellisen tehtävän koodia 
    
    Salasana on tämä, eli local_28,0x106399
    If salasana == 0 (eli TRUE) 
        return jotain esim flag
    else:
        return jotain esim "salasana väärin".

Highlightasin nämä hexadecimaalit ja laitoin kaikkiin "decimal" eli se muuttaa nämä kaikki decimaaliksi.

![alt text](image-38.png)

Testasin nämä kaikki, mutta ei tullut osumaa

![alt text](image-39.png)

Lähdin katsomaan muita funktioita, ennen kuin pureutuisin tähän sen enempää. 

Näistä ei löytynyt mitään niin mielenkiintoista

Tässä yksi esimerkki

![alt text](image-40.png)

Lähdinkin tutkimaan tätä aikaisempaa paremmin, sillä se vain tuntui juuri oikealta. Highlightasin koko funktion ja katsoin miltä se näyttää assemblyssa. 

Aluksi ei näyttänyt juuri miltään

![alt text](image-41.png)

Paitsi lopussa ruudun alas tuli selkotekstillä "whats's the password"

![alt text](image-42.png)

![alt text](image-43.png)

Koitin testata näitä vähän satunnaisesti, mutta ei osunut


![alt text](image-44.png)

### Takaisin alkuun

Hakkasin päätä varmaan tunnin ajan ja mietin mikä oli tässä ongelmana. Katsoin teron vinkit. Vinkeistä tajusin sen, että tehtävä on ehkä helpompi mitä ajattelin, tai ainaskin niin että siihen ei tarvittaisi Ghidraa vaan sen voisi tehdä ainoastaan strings avulla. Lähdinkin tutkimaan aikaisemmin löydettyä UPX file packeria. Googletin "UPX tutorial" ja vastaan tuli (kerrankin) hyödyllinen AI-yhteenveto

![alt text](image-45.png)

Tässä huomioni herätti -d decompress. 

Katsoin löytyiko Kalistani UPX ja katsoin lisää komentoja. 

![alt text](image-46.png)

Katsotaan onko tämä tehtävä vain niin simppeli että samalla työkalulla millä binääri on compressoitu sen voi uncompressoida... 

![alt text](image-47.png)

    upx -d packd
    strings packd | less

![alt text](image-48.png)

Ja siinä se näkyy, salasana on ``piilos-AnAnAs`` sekä ``FLAG{Tero-0e3bed0a89d8851da933c64fefad4ff2}``


![alt text](image-49.png)

Tämä olikin paljon simppelimpi tehtävä mitä oletin. Näin jälkeenpäin mietittynä ei olisi heti kannattanut lähteä selvittämään tehtävää ensimmäisellä ajatuksella mikä tulee mieleen vaan miettiä hetki. Myös vinkkejä olis voinut katsoa aikaisemmin, koska siellä sanotaan suoraan että "use the strings program". Jos jotain positiivista pitäisi löytää niin tulipa Ghidra tutuksi! : -)
# Lähteet

- Yuri Slobodyanyuk Binary obfuscation - String obfuscating in C, https://yurisk.info/2017/06/25/binary-obfuscation-string-obfuscating-in-C/
- UPX dokumentaatio, https://github.com/upx/upx
- Ghidra dokumentaatio, https://github.com/NationalSecurityAgency/ghidra
- John Hammond, Unpacking UPX Binaries, https://www.youtube.com/watch?v=0jVikfySiII
- Gemini 3 Pro-mode
- Kurssisivu, https://terokarvinen.com/application-hacking/